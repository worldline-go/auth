# Oauth2

For local oauth2 testing, we can use keycloak.

All the requests in golang usable with `auth/request` package.

To check the oauth2 specification, read the [rfc6749](https://datatracker.ietf.org/doc/html/rfc6749).

## Keycloak

Initialize keycloak with the following command:

```sh
docker run -it --rm -p 8080:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:20.0.2 start-dev
```

Then, go to http://localhost:8080 and login with the admin credentials.

Create a new client and create new user for this example.

## AccessToken with password grant

To get the accessToken directly with username and password, use the following request information.

In this approach we are sending the client credentials in the header with basic auth even client-secret is empty.
Basic-auth header is `base64(client_id:client_secret)`


If you have scopes, you can add them in the urlencode with space separated like this: `scope=openid profile email`

```sh
curl -X POST 'http://localhost:8080/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'Authorization: Basic ZXhhbXBsZS1jbGllbnQ6c2VjcmV0' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'username=example-user' \
--data-urlencode 'password=example-password'
```

Example output of the result:

```yaml
access_token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJsbmtHdDF3MUpBMWJvWUFlQVZQUFRjelluNjB2UGJ6dENWUDFXSFFGOWVnIn0.eyJleHAiOjE2ODg1NjUzMDIsImlhdCI6MTY4ODU2NTI0MiwianRpIjoiYTFmMmM4OTItOWQ2NC00ZDE5LWE5NmUtMmEwZTczMjRmZDdhIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9tYXN0ZXIiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiZDZhN2VhZWMtMzcwNy00NzI4LTgyZjAtZGJmYWYzYTEyYTNmIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoidGVzdCIsInNlc3Npb25fc3RhdGUiOiI1OGE2OTFlMi1lNGZmLTRlNzQtODRkZi00OWU1ZDIyYWVkODIiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImRlZmF1bHQtcm9sZXMtbWFzdGVyIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwicHJlZmVycmVkX3VzZXJuYW1lIjoieCIsImdpdmVuX25hbWUiOiIiLCJmYW1pbHlfbmFtZSI6IiJ9.kNA2ywCNKGkKSFL2btx43muSJkIl5gMRbvj714H3F3k8hJC57BCwR_K7OYCmLl1HGT6zS27ZVMje0NzwqlySxkxib4NY7rQ5_a-m-YL_2BT9D8rCf1iuEwAShFgkrQiGcfzXiFpED361C9wmRrU2U4EVyzObBARx3YAhRo4tiVJvyE0-CDyUY6E3WHhzHl9BFFOkdJkThfQQSnEraTJrYlBED9Sp1CBbmib_9nkKt4ugVIxnL4XxThEkfurF3YqBy3BnQgHrzPR9RiIXdTCOCI99ir_DTeArAnfBDpTAZZoQJEgiC_D6iJEboesv3x0jKmrwCB7YmBlG6Y8FbzFCtA
expires_in: 60
refresh_expires_in: 1800
refresh_token: eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI4YjMwODljNS1mNjJmLTRkY2QtYjgwYy1iNGExYjVlNGYxMTUifQ.eyJleHAiOjE2ODg1NjcwNDIsImlhdCI6MTY4ODU2NTI0MiwianRpIjoiNGVhNTRlYjYtOTViNi00MjVhLTg3MjEtNzJmZjkxNzVhMWY4IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9tYXN0ZXIiLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL21hc3RlciIsInN1YiI6ImQ2YTdlYWVjLTM3MDctNDcyOC04MmYwLWRiZmFmM2ExMmEzZiIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJ0ZXN0Iiwic2Vzc2lvbl9zdGF0ZSI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiIsInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiJ9.6QmV8PHkpNyQbWteeOFbf6mTOV5dtJCSPsS7LAMlNto
token_type: Bearer
not-before-policy: 0
session_state: 58a691e2-e4ff-4e74-84df-49e5d22aed82
scope: profile email
```

## Refresh token

Refresh token to refresh the access token. If you have `scope` you need to add it to the request.

Basic-auth header is `base64(client_id:client_secret)`

```sh
curl -X POST 'http://localhost:8080/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'Authorization: Basic ZXhhbXBsZS1jbGllbnQ6c2VjcmV0' \
--data-urlencode 'grant_type=refresh_token' \
--data-urlencode 'refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI4YjMwODljNS1mNjJmLTRkY2QtYjgwYy1iNGExYjVlNGYxMTUifQ.eyJleHAiOjE2ODg1NjcwNDIsImlhdCI6MTY4ODU2NTI0MiwianRpIjoiNGVhNTRlYjYtOTViNi00MjVhLTg3MjEtNzJmZjkxNzVhMWY4IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9tYXN0ZXIiLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL21hc3RlciIsInN1YiI6ImQ2YTdlYWVjLTM3MDctNDcyOC04MmYwLWRiZmFmM2ExMmEzZiIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJ0ZXN0Iiwic2Vzc2lvbl9zdGF0ZSI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiIsInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiJ9.6QmV8PHkpNyQbWteeOFbf6mTOV5dtJCSPsS7LAMlNto'
```

Example output of the result:

```yaml
access_token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJsbmtHdDF3MUpBMWJvWUFlQVZQUFRjelluNjB2UGJ6dENWUDFXSFFGOWVnIn0.eyJleHAiOjE2ODg1NjU4NDIsImlhdCI6MTY4ODU2NTc4MiwianRpIjoiYWQzZTk1ODgtMDI4Yy00ODk1LWI0NzMtODY4MjgwNGY0OTRiIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9tYXN0ZXIiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiZDZhN2VhZWMtMzcwNy00NzI4LTgyZjAtZGJmYWYzYTEyYTNmIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoidGVzdCIsInNlc3Npb25fc3RhdGUiOiI1OGE2OTFlMi1lNGZmLTRlNzQtODRkZi00OWU1ZDIyYWVkODIiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImRlZmF1bHQtcm9sZXMtbWFzdGVyIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwicHJlZmVycmVkX3VzZXJuYW1lIjoieCIsImdpdmVuX25hbWUiOiIiLCJmYW1pbHlfbmFtZSI6IiJ9.kzVyiIdCiKIqPm7M7n7P0a8vCcBX7bXYi21t6q4UZSOw3XbsQwcdzoeTeMj2VzptVpOq1L-9wQ7995dnulUrlQcH_w_6wolWbhLdtQvOb-gDyzoL-26mxzrWKQywZHxs3VIfdaUg681jM4EgMFDy-cUwyRTbtFhJdTd7futRVpbQp2pxsBCdegCXR4bD9HCbuAxVTglKNlviXspmHvYWKWCGqdyBSt3cVeIV9WaXEQeAlOe33_zkUDIwx-Y6t_6foT3S0NLh9kAPACxz97MaHvVVWj6Iv0oURG32070VOl3_amvUM-E0WKTbNpdIdFZ_cLOjBItpniozSi8DA6r3Fg
expires_in: 60
refresh_expires_in: 1800
refresh_token: eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI4YjMwODljNS1mNjJmLTRkY2QtYjgwYy1iNGExYjVlNGYxMTUifQ.eyJleHAiOjE2ODg1Njc1ODIsImlhdCI6MTY4ODU2NTc4MiwianRpIjoiYmFjZDRjYzQtM2NkOC00ZGFjLTlmMGItMjQ0ZDJhMzljOTY0IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9tYXN0ZXIiLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL21hc3RlciIsInN1YiI6ImQ2YTdlYWVjLTM3MDctNDcyOC04MmYwLWRiZmFmM2ExMmEzZiIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJ0ZXN0Iiwic2Vzc2lvbl9zdGF0ZSI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiIsInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6IjU4YTY5MWUyLWU0ZmYtNGU3NC04NGRmLTQ5ZTVkMjJhZWQ4MiJ9.SfBUHgBMDEaMErX_AaDcheDnSAtZaIHHDipiN23mJrQ
token_type: Bearer
not-before-policy: 0
session_state: 58a691e2-e4ff-4e74-84df-49e5d22aed82
scope: profile email
```
